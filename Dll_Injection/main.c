#include <stdio.h>
#include <Windows.h>
#include <TlHelp32.h>
#include <string.h>

BOOL GetTargetProcessHandle(_In_ LPWSTR sProcessName, _Out_ HANDLE* hTargProcess, _Out_ DWORD* dwTargProcessId) {
	HANDLE hSapShot = NULL;
	PROCESSENTRY32 sProcessEntry = { .dwSize = sizeof(PROCESSENTRY32) };

	if (!sProcessName || !hTargProcess || !dwTargProcessId) {
		printf("\t[-] GetTargetProcessHandle received invalid parameter(s)!\n");
		return FALSE;
	}

	wprintf(L"[i] Press <Enter> to Search for %s ID!\n", sProcessName);
	getch();

	hSapShot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
	if (!hSapShot) {
		printf("\t[-] CreateToolhelp32Snapshot failed with status: %d\n", GetLastError());
		return FALSE;
	}

	if (!Process32First(hSapShot, &sProcessEntry)) {
		printf("\t[-] Process32First failed with status: %d\n", GetLastError());
		goto _EndOfFunction;
	}

	do {
		if (_wcsicmp(sProcessEntry.szExeFile, sProcessName) == 0) {
			*dwTargProcessId = sProcessEntry.th32ProcessID;
			*hTargProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, sProcessEntry.th32ProcessID);
			if (!(*hTargProcess)) {
				printf("\t[-] OpenProcess failed with status: %d\n", GetLastError());
				goto _EndOfFunction;
			}
			break;
		}
	} while (Process32Next(hSapShot, &sProcessEntry));

_EndOfFunction:
	if (hSapShot)
		CloseHandle(hSapShot);

	if (!*dwTargProcessId || !*hTargProcess)
		return FALSE;

	printf("\t[&] Target Process Have PID: %d and Handle was Acquired!\n", *dwTargProcessId);
	printf("[+] Done!\n\n");
	return TRUE;
}

BOOL InjectDllToTargetProcess(_In_ LPWSTR wsDllPath, _In_ DWORD dwDllPathLength, _In_ HANDLE* hTargProcess, _Out_ LPVOID* pTarPageMem) {
	SIZE_T stNumberOfBytesWritten = NULL;
	BOOL bState = TRUE;

	if (!wsDllPath || !dwDllPathLength || !hTargProcess || !pTarPageMem) {
		printf("\t[-] InjectDllToTargetProcess received invalid parameter(s)!\n");
		return FALSE;
	}

	printf("[#] Press <Enter> to Inject the DLL Path!\n");
	getch();

	*pTarPageMem = VirtualAllocEx(*hTargProcess, NULL, dwDllPathLength, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	if (!*pTarPageMem) {
		printf("\t[-] VirtualAllocEx failed with status: %d\n", GetLastError());
		return FALSE;
	}

	printf("\t[i] Page Allocated at %p with PAGE_READWRITE Permissions!\n", *pTarPageMem);

	if (!WriteProcessMemory(*hTargProcess, *pTarPageMem, wsDllPath, dwDllPathLength, &stNumberOfBytesWritten) || stNumberOfBytesWritten != dwDllPathLength) {
		printf("\t[-] WriteProcessMemory failed with status: %d\n", GetLastError());
		bState = FALSE; goto _EndOfFunction;
	}

_EndOfFunction:
	if(bState)
		printf("[+] Done!\n\n");

	return bState;
}

BOOL GetFunctionAddress(LPVOID * pLoadLibrary) {
	if (!pLoadLibrary) {
		printf("\t[-] GetFunctionAddress received invalid parameter(s)!\n");
		return FALSE;
	}

	printf("[#] Press <Enter> to Get the LoadLibraryW Address!\n");
	getch();

	*pLoadLibrary = GetProcAddress(GetModuleHandleW(L"kernel32.dll"), "LoadLibraryW");
	if (!*pLoadLibrary) {
		printf("\t[-] GetProcAddress failed with status: %d\n", GetLastError());
		return FALSE;
	}

	printf("\t[i] DLL is at Address %p!\n", *pLoadLibrary);

	printf("[+] Done!\n\n");
	return TRUE;
}

int wmain(const int argc, const wchar_t* argv[]) {
	HANDLE hTargProcess = NULL;
	DWORD dwTargProcessId = NULL;
	LPVOID pTarPageMem = NULL;
	LPVOID pLoadLibrary = NULL;

	if (argc < 3) {
		wprintf(L"[-] \"%s\" Usage: <DLL FULL PATH> <TARGET PROCESS NAME>!\n", argv[0]);
		return 1;
	}

	DWORD dwDllPathLength = wcslen(argv[1]) * sizeof(WCHAR);

	if (!GetTargetProcessHandle(argv[2], &hTargProcess, &dwTargProcessId)) {
		printf("[-] Fail!\n");
		goto _EndOfFunction;
	}

	if (!InjectDllToTargetProcess(argv[1], dwDllPathLength, &hTargProcess, &pTarPageMem)) {
		printf("[-] Fail!\n");
		goto _EndOfFunction;
	}

	if (!GetFunctionAddress(&pLoadLibrary)) {
		printf("[-] Fail!\n");
		goto _EndOfFunction;
	}

	printf("[#] Press <Enter> to Execute the Remote Thread!\n");
	getch();

	CreateRemoteThread(hTargProcess, NULL, NULL, pLoadLibrary, pTarPageMem, NULL, NULL);

	printf("[+] Done!\n\n");

	printf("[#] Press <Enter> to Exit!\n");
	getch();

_EndOfFunction:
	if (pTarPageMem)
		VirtualFreeEx(hTargProcess, pTarPageMem, 0, MEM_DECOMMIT | MEM_RELEASE);
	
	if (hTargProcess)
		CloseHandle(hTargProcess);

	return 0;
}